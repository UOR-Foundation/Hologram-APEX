#!/bin/bash
# Pre-commit hook for Hologram project
# Enforces code quality standards from CLAUDE.md

set -e

echo "ðŸ” Running pre-commit checks..."
echo ""

# Check if we're in the root directory
if [ ! -f "Cargo.toml" ] || [ ! -d "crates" ]; then
    echo "âŒ Not in repository root directory"
    exit 1
fi

# Check if there are any staged changes
if git diff --cached --quiet; then
    echo "âš ï¸  No staged changes to commit"
    exit 0
fi

# Auto-fix formatting and stage changes
echo "ðŸ“ Auto-formatting code..."
if ! cargo fmt --all; then
    echo "âŒ Formatting failed!"
    exit 1
fi

# Stage any formatting changes automatically
if ! git diff --quiet --exit-code; then
    echo "ðŸ“ Auto-staging formatted files..."
    git add -u
fi
echo "âœ… Code formatting applied and staged"
echo ""

# Run clippy on workspace (zero warnings required)
echo "ðŸ”§ Running clippy (zero warnings required)..."
# Note: Build script warnings from hologram-core and hologram-codegen are expected
if ! cargo clippy --workspace --all-targets -- -D warnings; then
    echo "âŒ Clippy check failed!"
    echo "   Fix all warnings before committing"
    exit 1
fi
echo "âœ… Clippy passed"
echo ""

# Run tests (skip integration tests and resource-intensive crates)
# Exclude hologram-hrm due to memory constraints that cause SIGKILL
echo "ðŸ§ª Building and running unit tests (skipping integration tests and hologram-hrm)..."
if ! cargo test --workspace --lib --bins --exclude hologram-hrm -- --nocapture --color=always; then
    echo "âŒ Tests failed!"
    echo "   All unit tests must pass before committing"
    echo "   Run 'cargo test --workspace --lib --bins --exclude hologram-hrm' for detailed output"
    exit 1
fi
echo "âœ… All unit tests passed (hologram-hrm skipped due to resource constraints)"
echo ""

# Run Python tests if Python interface exists
if [ -d "hologram-sdk/python" ]; then
    echo "ðŸ Running Python tests..."
    if pushd hologram-sdk/python > /dev/null 2>&1; then
        # Check if virtual environment exists
        if [ -d ".venv" ]; then
            echo "ðŸ”§ Using virtual environment..."
            if source .venv/bin/activate 2>/dev/null; then
                if command -v pytest &> /dev/null; then
                    pytest -q --tb=short 2>/dev/null || echo "âš ï¸  Python tests failed or skipped"
                else
                    echo "âš ï¸  pytest not found, skipping Python tests"
                fi
                deactivate 2>/dev/null
            fi
        else
            echo "âš ï¸  No virtual environment found. Skipping Python tests."
            echo "ðŸ’¡ Consider running: cd hologram-sdk/python && python3 -m venv .venv"
        fi
        popd > /dev/null
    fi
fi

# Run TypeScript/JavaScript tests if they exist
if [ -d "hologram-sdk/typescript" ]; then
    echo "ðŸ“˜ Running TypeScript tests..."
    if pushd hologram-sdk/typescript > /dev/null 2>&1; then
        if [ -f "package.json" ] && [ -d "node_modules" ]; then
            echo "ðŸ”§ Running TypeScript tests..."
            npm test -- --passWithNoTests 2>/dev/null || echo "âš ï¸  TypeScript tests skipped"
        else
            echo "âš ï¸  node_modules not found. Skipping TypeScript tests."
            echo "ðŸ’¡ Run: cd hologram-sdk/typescript && npm install"
        fi
        popd > /dev/null
    fi
fi

echo ""
echo "âœ¨ All pre-commit checks passed! Ready to commit."
